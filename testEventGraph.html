

<!DOCTYPE html>
<meta charset="utf-8">
<style>
    html{
       background-color: #404040;
   }
   .node {

   }

   .label{
        fill:rgba(255,255,255,.6);
        font: 14px Helvetica;
        pointer-events: none;
  }

  .link {
      stroke: #fa5c4f;
      fill: transparent;
      stroke-width: 2px;
      stroke-opacity: .9;
  }
  .marker{
      fill: #fa5c4f;
  }

</style>
<body>
	<script src="js/lib/d3.v3.js" type="text/javascript"></script>
	<script type="text/javascript">

		var graph = {"nodes":[{"name":0,"handler_name":"EventHandler_","group":1},{"name":1,"handler_name":"EventHandler_1","group":1},{"name":2,"handler_name":"EventHandler_2","group":1},{"name":3,"handler_name":"EventHandler_3","group":1},{"name":2,"handler_name":"Function_4","group":2},{"name":2,"handler_name":"Function_5","group":2},{"name":2,"handler_name":"Function_6","group":2},{"name":2,"handler_name":"Function_7","group":2},{"name":8,"handler_name":"EventHandler_8","group":1},{"name":8,"handler_name":"Function_9","group":2},{"name":8,"handler_name":"Function_10","group":2},{"name":8,"handler_name":"Function_11","group":2},{"name":8,"handler_name":"Function_12","group":2},{"name":13,"handler_name":"EventHandler_13","group":1},{"name":14,"handler_name":"EventHandler_14","group":1},{"name":15,"handler_name":"EventHandler_15","group":1},{"name":14,"handler_name":"Function_16","group":2},{"name":14,"handler_name":"Function_17","group":2},{"name":14,"handler_name":"Function_18","group":2},{"name":14,"handler_name":"Function_19","group":2},{"name":14,"handler_name":"Function_20","group":2},{"name":15,"handler_name":"Function_21","group":2},{"name":15,"handler_name":"Function_22","group":2},{"name":15,"handler_name":"Function_23","group":2},{"name":24,"handler_name":"TouchSync_24","group":1},{"name":8,"handler_name":"Function_25","group":2},{"name":8,"handler_name":"Function_26","group":2},{"name":8,"handler_name":"Function_27","group":2},{"name":8,"handler_name":"Function_28","group":2},{"name":8,"handler_name":"Function_29","group":2},{"name":30,"handler_name":"EventHandler_30","group":1},{"name":30,"handler_name":"Function_31","group":2},{"name":30,"handler_name":"Function_32","group":2},{"name":30,"handler_name":"Function_33","group":2},{"name":30,"handler_name":"Function_34","group":2},{"name":30,"handler_name":"Function_35","group":2},{"name":30,"handler_name":"Function_36","group":2},{"name":30,"handler_name":"Function_37","group":2},{"name":30,"handler_name":"Function_38","group":2},{"name":30,"handler_name":"Function_39","group":2},{"name":1,"handler_name":"Function_40","group":2},{"name":3,"handler_name":"Function_41","group":2},{"name":1,"handler_name":"Function_42","group":2},{"name":3,"handler_name":"Function_43","group":2},{"name":1,"handler_name":"Function_44","group":2},{"name":3,"handler_name":"Function_45","group":2},{"name":30,"handler_name":"_isEscapeKeyDown","group":2},{"name":30,"handler_name":"_clearEscapeKey","group":2},{"name":30,"handler_name":"Function_48","group":2},{"name":49,"handler_name":"EventHandler_49","group":1},{"name":49,"handler_name":"Function_50","group":2},{"name":49,"handler_name":"Function_51","group":2},{"name":52,"handler_name":"EventHandler_52","group":1},{"name":53,"handler_name":"EventHandler_53","group":1},{"name":54,"handler_name":"EventHandler_54","group":1},{"name":55,"handler_name":"EventHandler_55","group":1},{"name":56,"handler_name":"EventHandler_56","group":1},{"name":55,"handler_name":"suface1ClickHandler","group":2},{"name":56,"handler_name":"surface2ClickHandler","group":2},{"name":53,"handler_name":"exampleView2ClickHandler","group":2},{"name":55,"handler_name":"Function_60","group":2},{"name":53,"handler_name":"helloWorldClickHandler","group":2}],"links":[{"id":"EventHandler_2-Function_4","source":2,"target":4,"value":2},{"id":"EventHandler_2-Function_5","source":2,"target":5,"value":2},{"id":"EventHandler_2-Function_6","source":2,"target":6,"value":2},{"id":"EventHandler_2-Function_7","source":2,"target":7,"value":2},{"id":"EventHandler_8-Function_9","source":8,"target":9,"value":2},{"id":"EventHandler_8-Function_10","source":8,"target":10,"value":2},{"id":"EventHandler_8-Function_11","source":8,"target":11,"value":2},{"id":"EventHandler_8-Function_12","source":8,"target":12,"value":2},
    
    {"id":"EventHandler_3-EventHandler_1","source":3,"target":1,"value":3},

    {"id":"EventHandler_14-Function_16","source":14,"target":16,"value":2},{"id":"EventHandler_14-Function_17","source":14,"target":17,"value":2},{"id":"EventHandler_14-Function_18","source":14,"target":18,"value":2},{"id":"EventHandler_14-Function_19","source":14,"target":19,"value":2},{"id":"EventHandler_14-Function_20","source":14,"target":20,"value":2},{"id":"EventHandler_15-Function_21","source":15,"target":21,"value":2},{"id":"EventHandler_15-Function_22","source":15,"target":22,"value":2},{"id":"EventHandler_15-Function_23","source":15,"target":23,"value":2},{"id":"EventHandler_8-TouchSync_24","source":8,"target":24,"value":3},{"id":"EventHandler_8-Function_25","source":8,"target":25,"value":2},{"id":"EventHandler_8-Function_26","source":8,"target":26,"value":2},{"id":"EventHandler_8-Function_27","source":8,"target":27,"value":2},{"id":"EventHandler_8-Function_28","source":8,"target":28,"value":2},{"id":"EventHandler_8-Function_29","source":8,"target":29,"value":2},{"id":"EventHandler_13-EventHandler_1","source":13,"target":1,"value":3},{"id":"EventHandler_30-Function_31","source":30,"target":31,"value":2},{"id":"EventHandler_30-Function_32","source":30,"target":32,"value":2},{"id":"EventHandler_30-Function_33","source":30,"target":33,"value":2},{"id":"EventHandler_30-Function_34","source":30,"target":34,"value":2},{"id":"EventHandler_30-Function_35","source":30,"target":35,"value":2},{"id":"EventHandler_30-Function_36","source":30,"target":36,"value":2},{"id":"EventHandler_30-Function_37","source":30,"target":37,"value":2},{"id":"EventHandler_30-Function_38","source":30,"target":38,"value":2},{"id":"EventHandler_30-Function_39","source":30,"target":39,"value":2},{"id":"EventHandler_1-Function_40","source":1,"target":40,"value":2},{"id":"EventHandler_3-Function_41","source":3,"target":41,"value":2},{"id":"EventHandler_13-Function_41","source":13,"target":41,"value":2},{"id":"EventHandler_1-Function_42","source":1,"target":42,"value":2},{"id":"EventHandler_3-Function_43","source":3,"target":43,"value":2},{"id":"EventHandler_13-Function_43","source":13,"target":43,"value":2},{"id":"EventHandler_1-Function_44","source":1,"target":44,"value":2},{"id":"EventHandler_3-Function_45","source":3,"target":45,"value":2},{"id":"EventHandler_13-Function_45","source":13,"target":45,"value":2},{"id":"EventHandler_30-_isEscapeKeyDown","source":30,"target":46,"value":2},{"id":"EventHandler_30-_clearEscapeKey","source":30,"target":47,"value":2},{"id":"EventHandler_30-Function_48","source":30,"target":48,"value":2},{"id":"EventHandler_49-Function_50","source":49,"target":50,"value":2},{"id":"EventHandler_49-Function_51","source":49,"target":51,"value":2},{"id":"EventHandler_55-EventHandler_53","source":55,"target":53,"value":3},{"id":"EventHandler_55-suface1ClickHandler","source":55,"target":57,"value":2},{"id":"EventHandler_56-surface2ClickHandler","source":56,"target":58,"value":2},{"id":"EventHandler_53-exampleView2ClickHandler","source":53,"target":59,"value":2},{"id":"EventHandler_55-Function_60","source":55,"target":60,"value":2},{"id":"EventHandler_53-helloWorldClickHandler","source":53,"target":61,"value":2}]};


  var _color = d3.scale.category20();

  function EventGraphVisualizer(graph, options){
    this.graph = graph;
    this.container = options.container;
  }


  EventGraphVisualizer.prototype.render = function render(){









    var width = window.innerWidth,
            height = window.innerHeight;


        

        var force = d3.layout.force()
            .nodes(this.graph.nodes)
            .links(this.graph.links)
            .size([width, height])
            .linkDistance(60)
            .charge(-100)
            .on("tick", tick)
            .start();

        var drag = force.drag()
        .on("dragstart", dragstart);
        
            
        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);


    // build the arrow.
        svg.append("svg:defs").selectAll("marker")
      .data(["end"])      // Different link/path types can be defined here
      .enter().append("svg:marker")    // This section adds in the arrows
                .attr("id", String)
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 15)
                .attr("refY", -1.5)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("svg:path")
                .attr("d", "M0,-5L10,0L0,5");

    // add the links and the arrows
    var path = svg.append("svg:g").selectAll("path")
      .data(force.links())
      .enter().append("svg:path")
        .attr("class", "link")
        .attr("marker-end", "url(#end)");


    // define the nodes
    var node = svg.selectAll(".node")
      .data(force.nodes())
      .enter().append("g")
        .attr("class", "node")
        .attr("id", function(d){return d.handler_name})
        .style("fill", function(d) { return _color(d.group); })
        .on("dblclick", dblclick)
        .on("click", click)
        .call(drag);


    // add the nodes
    node.append("circle")
          .attr("r", 10);


    // add the text 
    node.append("text")
      .attr("x", 12)
      .attr("class", "label")
      .attr("dy", ".4em")
      .text(function(d) { return d.handler_name; });

    // add the curvy lines
    function tick() {
          path.attr("d", function(d) {
        var dx = d.target.x - d.source.x,
          dy = d.target.y - d.source.y,
          dr = Math.sqrt(dx * dx + dy * dy);
        
        return "M" + 
          d.source.x + "," + 
          d.source.y + "A" + 
          dr + "," + dr + " 0 0,1 " + 
          d.target.x + "," + 
          d.target.y;
            });

          node
            .attr("transform", function(d) { 
                return "translate(" + d.x + "," + d.y + ")"; 
              });
      }//end tick

      function dblclick(d) {
      d3.select(this).classed("fixed", d.fixed = false);
    }

    function dragstart(d) {
      d3.select(this).classed("fixed", d.fixed = true);
    }




    var root = this.graph,
        link = svg.selectAll(".link"),
        node = svg.selectAll(".node");

    // Toggle children on click.
    function click(d) {
      if (d3.event.defaultPrevented) return; // ignore drag
      if (d.children) {
        d._children = d.children;
        d.children = null;
      } else {
        d.children = d._children;
        d._children = null;
      }
      update();
    }

    // Returns a list of all nodes under the root.
    function flatten(root) {
      debugger
      var nodes = [], i = 0;

      function recurse(node) {
        if (node.children) node.children.forEach(recurse);
        if (!node.id) node.id = ++i;
        nodes.push(node);
      }

      recurse(root);
      return nodes;
    }



    function update() {
      var nodes = flatten(root),
          links = d3.layout.tree().links(nodes);

      // Restart the force layout.
      force
          .nodes(nodes)
          .links(links)
          .start();

      // Update links.
      link = link.data(links, function(d) { return d.target.id; });

      link.exit().remove();

      link.enter().insert("line", ".node")
          .attr("class", "link");

      // Update nodes.
      node = node.data(nodes, function(d) { return d.id; });

      node.exit().remove();

      var nodeEnter = node.enter().append("g")
          .attr("class", "node")
          .on("click", click)
          .call(force.drag);

      nodeEnter.append("circle")
          .attr("r", function(d) { return Math.sqrt(d.size) / 10 || 4.5; });

      nodeEnter.append("text")
          .attr("dy", ".35em")
          .text(function(d) { return d.name; });

      node.select("circle")
          .style("fill", _color);
    }







  }//end function render



  EventGraphVisualizer.prototype.replayEventStack = function replayEventStack(eventStack){
    console.log(eventStack);
    
    var i = 0;
    var intervalHandle = setInterval(function(){
      //get out of here if done
      if(i >= eventStack.length){clearInterval(intervalHandle); return;}

      var event = eventStack[i];
      var nodeID = "#EventHandler_" + event.id;

      //if its a callback versus a handler, update it
      if(event.handler){
        //debugger
        nodeID = "#" + (event.handler.name || ("Function_" + event.handler.id));
      }

      //show the node
      var node = d3.select(nodeID);
      var duration = 300;

      node.transition()
              .duration(duration)
              .style("fill", function() {
                  return "green";
              });

          setTimeout(function(){
            node.transition()
                .duration(duration * 15)
                .style("fill", function(d) {
                    return _color(d.group);
                });

          },duration);




          //loop through
      i++;
    },300);
  }


  var egv = new EventGraphVisualizer(graph, {container: "container"});
  egv.render();


  </script>

  <div id="container"></div>
</body>
</html>